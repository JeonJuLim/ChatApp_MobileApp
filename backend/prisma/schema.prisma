// ===================================================
//  Prisma Chat App Schema
//  Author: Huy - InitBE Branch
// ===================================================

// Prisma Client generator
generator client {
  provider = "prisma-client-js"
}

// Database connection
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}


// ===========================
// USERS
// ===========================
model User {
  id           String   @id @default(uuid())
  username     String   @unique
  fullName     String
  passwordHash String
  avatarUrl    String?
  status       String? // online, offline, typing
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  conversationsCreated Conversation[]       @relation("creator")
  messages             Message[]
  messageStatus        MessageStatus[]
  members              ConversationMember[]
  contactsOwner        Contact[]            @relation("owner")
  contactsFriend       Contact[]            @relation("friend")
  callLogsCaller       CallLog[]            @relation("caller")
  callLogsReceiver     CallLog[]            @relation("receiver")
}

// ===========================
// CONVERSATIONS
// ===========================
model Conversation {
  id        String   @id @default(uuid())
  type      String // "direct" | "group"
  name      String?
  avatarUrl String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  createdBy String
  creator   User   @relation("creator", fields: [createdBy], references: [id])

  members  ConversationMember[]
  messages Message[]
  callLogs CallLog[]
}

// ===========================
// CONVERSATION MEMBERS
// ===========================
model ConversationMember {
  id       String   @id @default(uuid())
  role     String // "member" | "admin"
  joinedAt DateTime @default(now())

  conversationId String
  userId         String

  conversation Conversation @relation(fields: [conversationId], references: [id])
  user         User         @relation(fields: [userId], references: [id])
   @@unique([conversationId, userId])
}

// ===========================
// MESSAGES
// ===========================
model Message {
  id        String   @id @default(uuid())
  content   String?
  type      String // text, image, audio, file, call, system
  createdAt DateTime @default(now())

  conversationId String
  senderId       String
  replyToId      String?

  conversation  Conversation    @relation(fields: [conversationId], references: [id])
  sender        User            @relation(fields: [senderId], references: [id])
  replyTo       Message?        @relation("reply", fields: [replyToId], references: [id])
  replies       Message[]       @relation("reply")
  messageStatus MessageStatus[]
  attachments   Attachment[]
}

// ===========================
// MESSAGE STATUS (delivered/seen)
// ===========================
model MessageStatus {
  id        String   @id @default(uuid())
  status    String // sent | delivered | seen
  updatedAt DateTime @updatedAt

  messageId String
  userId    String

  message Message @relation(fields: [messageId], references: [id])
  user    User    @relation(fields: [userId], references: [id])
}

// ===========================
// ATTACHMENTS (MinIO files)
// ===========================
model Attachment {
  id        String   @id @default(uuid())
  type      String // image, audio, file
  url       String
  size      Int?
  createdAt DateTime @default(now())

  messageId String
  message   Message @relation(fields: [messageId], references: [id])
}

// ===========================
// CONTACTS (friend list)
// ===========================
model Contact {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  ownerId   String
  contactId String

  owner  User @relation("owner", fields: [ownerId], references: [id])
  friend User @relation("friend", fields: [contactId], references: [id])
}

// ===========================
// CALL LOGS (audio/video)
// ===========================
model CallLog {
  id        String   @id @default(uuid())
  type      String // audio | video
  status    String // missed | accepted | ended
  duration  Int?
  createdAt DateTime @default(now())

  callerId       String
  receiverId     String
  conversationId String

  caller       User         @relation("caller", fields: [callerId], references: [id])
  receiver     User         @relation("receiver", fields: [receiverId], references: [id])
  conversation Conversation @relation(fields: [conversationId], references: [id])
}
